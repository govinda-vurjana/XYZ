<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Creation Test - ScriptEase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0f172a;
            color: white;
        }
        .test-section {
            background-color: #1e293b;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        button {
            background-color: #f59e0b;
            color: #0f172a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #d97706;
        }
        input, textarea {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px;
            width: 300px;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .script-card {
            background-color: #374151;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #4b5563;
        }
    </style>
</head>
<body>
    <h1>🧪 ScriptEase Script Creation Test Page</h1>
    
    <div class="test-section">
        <h2>Setup Test User</h2>
        <p>First, create a test user to test script creation:</p>
        <input type="text" id="userName" placeholder="Name" value="Test Writer">
        <input type="email" id="userEmail" placeholder="Email" value="writer@example.com">
        <input type="password" id="userPassword" placeholder="Password" value="password123">
        <button onclick="setupTestUser()">Create Test User</button>
        <div id="userSetupResult"></div>
    </div>

    <div class="test-section">
        <h2>Script Creation Tests</h2>
        
        <div>
            <h3>Test Case 1: Create Valid Script</h3>
            <input type="text" id="title1" placeholder="Script Title" value="The Coffee Shop Mystery">
            <textarea id="description1" placeholder="Script Description">A short film about a detective who solves crimes in a local coffee shop, using only the conversations he overhears.</textarea>
            <button onclick="testCreateScript('title1', 'description1', 'result1')">Create Script</button>
            <div id="result1"></div>
        </div>

        <div>
            <h3>Test Case 2: Create Script with Empty Title</h3>
            <input type="text" id="title2" placeholder="Script Title" value="">
            <textarea id="description2" placeholder="Script Description">This should fail because title is empty.</textarea>
            <button onclick="testCreateScript('title2', 'description2', 'result2')">Create Script (Should Fail)</button>
            <div id="result2"></div>
        </div>

        <div>
            <h3>Test Case 3: Create Script with Long Title</h3>
            <input type="text" id="title3" placeholder="Script Title" value="This is a very long title that exceeds the maximum allowed length of 100 characters and should be rejected by the validation">
            <textarea id="description3" placeholder="Script Description">Testing title length validation.</textarea>
            <button onclick="testCreateScript('title3', 'description3', 'result3')">Create Script (Should Fail)</button>
            <div id="result3"></div>
        </div>

        <div>
            <h3>Test Case 4: Create Multiple Scripts</h3>
            <input type="text" id="title4" placeholder="Script Title" value="Midnight Express">
            <textarea id="description4" placeholder="Script Description">A thriller about a late-night train journey that takes an unexpected turn.</textarea>
            <button onclick="testCreateScript('title4', 'description4', 'result4')">Create Second Script</button>
            <div id="result4"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>Script Management</h2>
        <button onclick="showUserScripts()">Show All User Scripts</button>
        <button onclick="clearAllScripts()">Clear All Scripts</button>
        <div id="scriptsList"></div>
    </div>

    <div class="test-section">
        <h2>localStorage Contents</h2>
        <button onclick="showStorage()">Show localStorage</button>
        <div id="storageContents"></div>
    </div>

    <script>
        // Mock services for testing
        class AuthService {
            static USER_KEY = 'scriptease_user';
            static TOKEN_KEY = 'scriptease_token';

            static async signup(email, password, name) {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters');
                }
                if (name.trim().length < 2) {
                    throw new Error('Name must be at least 2 characters');
                }

                const existingUsers = this.getStoredUsers();
                if (existingUsers.some(u => u.email === email)) {
                    throw new Error('User already exists with this email');
                }

                const user = {
                    id: `user_${Date.now()}`,
                    email: email,
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                };

                existingUsers.push(user);
                localStorage.setItem('scriptease_users', JSON.stringify(existingUsers));
                localStorage.setItem(this.USER_KEY, JSON.stringify(user));
                localStorage.setItem(this.TOKEN_KEY, `token_${Date.now()}`);

                return user;
            }

            static getStoredUsers() {
                const usersStr = localStorage.getItem('scriptease_users');
                if (!usersStr) return [];
                try {
                    return JSON.parse(usersStr);
                } catch {
                    return [];
                }
            }

            static getCurrentUser() {
                const userStr = localStorage.getItem(this.USER_KEY);
                if (!userStr) return null;
                try {
                    return JSON.parse(userStr);
                } catch {
                    return null;
                }
            }

            static logout() {
                localStorage.removeItem(this.USER_KEY);
                localStorage.removeItem(this.TOKEN_KEY);
            }
        }

        class ScriptService {
            static SCRIPTS_KEY = 'scriptease_scripts';

            static async createScript(userId, request) {
                await new Promise(resolve => setTimeout(resolve, 800));

                if (!request.title.trim()) {
                    throw new Error('Script title is required');
                }
                if (request.title.trim().length > 100) {
                    throw new Error('Script title must be 100 characters or less');
                }
                if (request.description.length > 500) {
                    throw new Error('Script description must be 500 characters or less');
                }

                const script = {
                    id: `script_${Date.now()}_${Math.random().toString(36).substring(2)}`,
                    userId: userId,
                    title: request.title.trim(),
                    description: request.description.trim(),
                    content: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    pageCount: 0
                };

                const existingScripts = this.getStoredScripts();
                existingScripts.push(script);
                localStorage.setItem(this.SCRIPTS_KEY, JSON.stringify(existingScripts));

                return script;
            }

            static getUserScripts(userId) {
                const allScripts = this.getStoredScripts();
                return allScripts
                    .filter(script => script.userId === userId)
                    .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
            }

            static getStoredScripts() {
                const scriptsStr = localStorage.getItem(this.SCRIPTS_KEY);
                if (!scriptsStr) return [];
                try {
                    return JSON.parse(scriptsStr);
                } catch {
                    return [];
                }
            }

            static formatTimeAgo(dateString) {
                const now = new Date();
                const date = new Date(dateString);
                const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours === 1 ? '' : 's'} ago`;
                } else {
                    return date.toLocaleDateString();
                }
            }
        }

        let currentUser = null;

        async function setupTestUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const resultDiv = document.getElementById('userSetupResult');

            resultDiv.innerHTML = '<p class="info">Creating test user...</p>';

            try {
                // Clear existing user first
                AuthService.logout();
                
                currentUser = await AuthService.signup(email, password, name);
                resultDiv.innerHTML = `
                    <p class="success">✅ Test user created successfully!</p>
                    <p>User ID: ${currentUser.id}</p>
                    <p>Name: ${currentUser.name}</p>
                    <p>Email: ${currentUser.email}</p>
                `;
            } catch (error) {
                // If user already exists, try to use existing user
                if (error.message.includes('already exists')) {
                    const existingUsers = AuthService.getStoredUsers();
                    currentUser = existingUsers.find(u => u.email === email);
                    if (currentUser) {
                        localStorage.setItem('scriptease_user', JSON.stringify(currentUser));
                        localStorage.setItem('scriptease_token', `token_${Date.now()}`);
                        resultDiv.innerHTML = `
                            <p class="success">✅ Using existing test user!</p>
                            <p>User ID: ${currentUser.id}</p>
                            <p>Name: ${currentUser.name}</p>
                            <p>Email: ${currentUser.email}</p>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ Failed to create user: ${error.message}</p>`;
                }
            }
        }

        async function testCreateScript(titleId, descriptionId, resultId) {
            const title = document.getElementById(titleId).value;
            const description = document.getElementById(descriptionId).value;
            const resultDiv = document.getElementById(resultId);

            if (!currentUser) {
                resultDiv.innerHTML = '<p class="error">❌ Please create a test user first</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="info">Creating script...</p>';

            try {
                const request = { title, description };
                const script = await ScriptService.createScript(currentUser.id, request);
                
                resultDiv.innerHTML = `
                    <p class="success">✅ Script created successfully!</p>
                    <div class="script-card">
                        <p><strong>ID:</strong> ${script.id}</p>
                        <p><strong>Title:</strong> ${script.title}</p>
                        <p><strong>Description:</strong> ${script.description}</p>
                        <p><strong>Created:</strong> ${script.createdAt}</p>
                        <p><strong>Page Count:</strong> ${script.pageCount}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ Script creation failed: ${error.message}</p>`;
            }
        }

        function showUserScripts() {
            const scriptsDiv = document.getElementById('scriptsList');
            
            if (!currentUser) {
                scriptsDiv.innerHTML = '<p class="error">❌ Please create a test user first</p>';
                return;
            }

            const scripts = ScriptService.getUserScripts(currentUser.id);
            
            if (scripts.length === 0) {
                scriptsDiv.innerHTML = '<p class="info">No scripts found for this user</p>';
                return;
            }

            const scriptCards = scripts.map(script => `
                <div class="script-card">
                    <h4>${script.title}</h4>
                    <p><strong>Description:</strong> ${script.description || 'No description'}</p>
                    <p><strong>Created:</strong> ${ScriptService.formatTimeAgo(script.createdAt)}</p>
                    <p><strong>Updated:</strong> ${ScriptService.formatTimeAgo(script.updatedAt)}</p>
                    <p><strong>Pages:</strong> ${script.pageCount}</p>
                    <p><strong>ID:</strong> <code>${script.id}</code></p>
                </div>
            `).join('');

            scriptsDiv.innerHTML = `
                <p class="success">✅ Found ${scripts.length} script${scripts.length === 1 ? '' : 's'}:</p>
                ${scriptCards}
            `;
        }

        function clearAllScripts() {
            localStorage.removeItem('scriptease_scripts');
            document.getElementById('scriptsList').innerHTML = '<p class="success">✅ All scripts cleared</p>';
            showStorage();
        }

        function showStorage() {
            const storageDiv = document.getElementById('storageContents');
            const items = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('scriptease_')) {
                    const value = localStorage.getItem(key);
                    items.push(`<p><strong>${key}:</strong></p><pre style="background: #374151; padding: 10px; border-radius: 4px; overflow-x: auto;">${value}</pre>`);
                }
            }

            storageDiv.innerHTML = items.length > 0 ? items.join('') : '<p class="info">No ScriptEase data in localStorage</p>';
        }

        // Initialize
        currentUser = AuthService.getCurrentUser();
        if (currentUser) {
            document.getElementById('userSetupResult').innerHTML = `
                <p class="success">✅ Current user loaded from localStorage:</p>
                <p>User ID: ${currentUser.id}</p>
                <p>Name: ${currentUser.name}</p>
                <p>Email: ${currentUser.email}</p>
            `;
        }
        showStorage();
    </script>
</body>
</html>