<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 8 Test - Voice Input Integration</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: white;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, forwardRef, useImperativeHandle } = React;

        // Voice Input Component
        function VoiceInput({ onTextReceived, onError, className = '' }) {
            const [isListening, setIsListening] = useState(false);
            const [isSupported, setIsSupported] = useState(false);
            const [interimText, setInterimText] = useState('');
            const recognitionRef = useRef(null);
            const silenceTimeoutRef = useRef(null);

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                setIsSupported(!!SpeechRecognition);

                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';

                    recognition.addEventListener('start', () => {
                        setIsListening(true);
                        setInterimText('');
                    });

                    recognition.addEventListener('end', () => {
                        setIsListening(false);
                        setInterimText('');
                        if (silenceTimeoutRef.current) {
                            clearTimeout(silenceTimeoutRef.current);
                        }
                    });

                    recognition.addEventListener('result', (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        setInterimText(interimTranscript);

                        if (finalTranscript) {
                            onTextReceived(finalTranscript);
                            setInterimText('');
                            
                            // Auto-pause after 3 seconds of silence
                            if (silenceTimeoutRef.current) {
                                clearTimeout(silenceTimeoutRef.current);
                            }
                            silenceTimeoutRef.current = setTimeout(() => {
                                if (recognitionRef.current && isListening) {
                                    recognition.stop();
                                }
                            }, 3000);
                        }
                    });

                    recognition.addEventListener('error', (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsListening(false);
                        setInterimText('');
                        
                        let errorMessage = 'Voice input error occurred';
                        switch (event.error) {
                            case 'no-speech':
                                errorMessage = 'No speech detected. Please try again.';
                                break;
                            case 'audio-capture':
                                errorMessage = 'Microphone not accessible. Please check permissions.';
                                break;
                            case 'not-allowed':
                                errorMessage = 'Microphone access denied. Please allow microphone access.';
                                break;
                            case 'network':
                                errorMessage = 'Network error. Please check your connection.';
                                break;
                            default:
                                errorMessage = `Speech recognition error: ${event.error}`;
                        }
                        
                        onError?.(errorMessage);
                    });

                    recognitionRef.current = recognition;
                }

                return () => {
                    if (recognitionRef.current) {
                        recognitionRef.current.stop();
                    }
                    if (silenceTimeoutRef.current) {
                        clearTimeout(silenceTimeoutRef.current);
                    }
                };
            }, [onTextReceived, onError, isListening]);

            const toggleListening = () => {
                if (!isSupported) {
                    onError?.('Speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }

                if (!recognitionRef.current) {
                    onError?.('Speech recognition not initialized.');
                    return;
                }

                if (isListening) {
                    recognitionRef.current.stop();
                    if (silenceTimeoutRef.current) {
                        clearTimeout(silenceTimeoutRef.current);
                    }
                } else {
                    try {
                        recognitionRef.current.start();
                    } catch (error) {
                        console.error('Failed to start speech recognition:', error);
                        onError?.('Failed to start voice input. Please try again.');
                    }
                }
            };

            if (!isSupported) {
                return (
                    <div className={`${className} flex flex-col items-center`}>
                        <button
                            disabled
                            className="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center cursor-not-allowed opacity-50"
                            title="Speech recognition not supported in this browser"
                        >
                            <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728" />
                            </svg>
                        </button>
                        <p className="text-xs text-gray-500 mt-2 text-center">
                            Voice input not supported
                        </p>
                    </div>
                );
            }

            return (
                <div className={`${className} flex flex-col items-center`}>
                    <button
                        onClick={toggleListening}
                        className={`
                            w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-500/30
                            ${isListening 
                                ? 'bg-gradient-to-r from-red-500 to-red-600 shadow-lg shadow-red-500/30 animate-pulse' 
                                : 'bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 shadow-lg shadow-amber-500/30'
                            }
                        `}
                        title={isListening ? 'Stop voice input' : 'Start voice input'}
                    >
                        {isListening ? (
                            <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 6h12v12H6z"/>
                            </svg>
                        ) : (
                            <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        )}
                    </button>

                    <div className="mt-3 text-center min-h-[2.5rem]">
                        {isListening && (
                            <div className="space-y-1">
                                <p className="text-sm text-amber-300 font-medium">
                                    ðŸŽ¤ Listening...
                                </p>
                                {interimText && (
                                    <p className="text-xs text-gray-400 italic max-w-xs">
                                        "{interimText}"
                                    </p>
                                )}
                                <p className="text-xs text-gray-500">
                                    Speak now â€¢ Auto-pauses after 3 seconds of silence
                                </p>
                            </div>
                        )}
                        
                        {!isListening && (
                            <div className="space-y-1">
                                <p className="text-sm text-gray-300">
                                    Click to start voice input
                                </p>
                                <p className="text-xs text-gray-500">
                                    Speak dialogue, action lines, or scene descriptions
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Formatted Script Editor Component (simplified)
        const FormattedScriptEditor = forwardRef(({ content, onChange, onCursorPositionChange, placeholder, className }, ref) => {
            const textareaRef = useRef(null);

            useImperativeHandle(ref, () => ({
                getTextareaRef: () => textareaRef.current
            }));

            const handleChange = (e) => {
                onChange(e.target.value);
                onCursorPositionChange?.(e.target.selectionStart);
            };

            const handleSelect = () => {
                if (textareaRef.current) {
                    onCursorPositionChange?.(textareaRef.current.selectionStart);
                }
            };

            return (
                <textarea
                    ref={textareaRef}
                    value={content}
                    onChange={handleChange}
                    onSelect={handleSelect}
                    onClick={handleSelect}
                    placeholder={placeholder}
                    className={`w-full h-96 bg-slate-700/50 border border-slate-600 rounded-lg p-4 text-white resize-none focus:outline-none focus:ring-2 focus:ring-amber-500/50 ${className}`}
                />
            );
        });

        // Main Test App
        function Task8TestApp() {
            const [content, setContent] = useState(`FADE IN:

INT. COFFEE SHOP - DAY

Sunlight streams through the window of a bustling cafe. ANNA (30s), a screenwriter, stares intently at her laptop, a half-empty mug beside her.

MARK
Another refill? You've been here for hours.

Anna looks up, startled, at MARK (40s), a cheerful barista.

ANNA
Just trying to crack this scene. It's not working.

MARK
(leaning in conspiratorially)
Maybe you need a different kind of inspiration.

ANNA
(Intrigued)
What did you have in mind?`);
            const [voiceError, setVoiceError] = useState(null);
            const [cursorPosition, setCursorPosition] = useState(0);
            const [testResults, setTestResults] = useState([]);
            const editorRef = useRef(null);

            const handleVoiceText = (voiceText) => {
                const textarea = editorRef.current?.getTextareaRef();
                if (!textarea) return;

                const currentCursorPosition = textarea.selectionStart;
                const textBefore = content.substring(0, currentCursorPosition);
                const textAfter = content.substring(currentCursorPosition);
                
                const cleanedVoiceText = voiceText.trim();
                const formattedText = cleanedVoiceText.charAt(0).toUpperCase() + cleanedVoiceText.slice(1);
                
                const needsSpaceBefore = textBefore.length > 0 && !textBefore.endsWith(' ') && !textBefore.endsWith('\n');
                const needsSpaceAfter = textAfter.length > 0 && !textAfter.startsWith(' ') && !textAfter.startsWith('\n');
                
                const finalText = (needsSpaceBefore ? ' ' : '') + formattedText + (needsSpaceAfter ? ' ' : '');
                const newContent = textBefore + finalText + textAfter;
                
                setContent(newContent);
                
                const newCursorPosition = currentCursorPosition + finalText.length;
                setTimeout(() => {
                    textarea.selectionStart = textarea.selectionEnd = newCursorPosition;
                    textarea.focus();
                    setCursorPosition(newCursorPosition);
                }, 0);

                // Log test result
                setTestResults(prev => [...prev, {
                    type: 'success',
                    message: `Voice text inserted: "${voiceText}" â†’ "${finalText}"`,
                    timestamp: new Date().toLocaleTimeString()
                }]);

                setVoiceError(null);
            };

            const handleVoiceError = (error) => {
                setVoiceError(error);
                setTestResults(prev => [...prev, {
                    type: 'error',
                    message: `Voice error: ${error}`,
                    timestamp: new Date().toLocaleTimeString()
                }]);
                setTimeout(() => setVoiceError(null), 5000);
            };

            const handleContentChange = (newContent) => {
                setContent(newContent);
            };

            const handleCursorPositionChange = (position) => {
                setCursorPosition(position);
            };

            const runAutomatedTests = () => {
                setTestResults([]);
                
                // Test 1: Check if voice button exists
                const voiceButton = document.querySelector('button[title*="voice input"]');
                setTestResults(prev => [...prev, {
                    type: voiceButton ? 'success' : 'error',
                    message: `âœ“ Voice button ${voiceButton ? 'found' : 'not found'}`,
                    timestamp: new Date().toLocaleTimeString()
                }]);

                // Test 2: Check if Web Speech API is supported
                const isSupported = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
                setTestResults(prev => [...prev, {
                    type: isSupported ? 'success' : 'warning',
                    message: `âœ“ Web Speech API ${isSupported ? 'supported' : 'not supported in this browser'}`,
                    timestamp: new Date().toLocaleTimeString()
                }]);

                // Test 3: Check if script editor exists
                const scriptEditor = document.querySelector('textarea');
                setTestResults(prev => [...prev, {
                    type: scriptEditor ? 'success' : 'error',
                    message: `âœ“ Script editor ${scriptEditor ? 'found' : 'not found'}`,
                    timestamp: new Date().toLocaleTimeString()
                }]);

                // Test 4: Check cursor position tracking
                setTestResults(prev => [...prev, {
                    type: 'success',
                    message: `âœ“ Cursor position tracking: ${cursorPosition}`,
                    timestamp: new Date().toLocaleTimeString()
                }]);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-8">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-amber-400 mb-2">Task 8 Test: Voice Input Integration</h1>
                            <p className="text-gray-400">Testing voice input button and speech recognition in script editor</p>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Script Editor */}
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                <div className="mb-4">
                                    <h2 className="text-xl font-semibold text-white mb-2">Script Editor</h2>
                                    <p className="text-sm text-gray-400">Cursor Position: {cursorPosition}</p>
                                </div>
                                
                                <FormattedScriptEditor
                                    ref={editorRef}
                                    content={content}
                                    onChange={handleContentChange}
                                    onCursorPositionChange={handleCursorPositionChange}
                                    placeholder="Start writing your script here..."
                                    className="font-mono text-sm leading-relaxed"
                                />
                                
                                <div className="mt-4 text-sm text-gray-400">
                                    <span>{content.length} characters â€¢ {content.split('\n').length} lines</span>
                                </div>
                            </div>

                            {/* Voice Input & Testing */}
                            <div className="space-y-6">
                                {/* Voice Input */}
                                <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                    <h2 className="text-xl font-semibold text-white mb-4 text-center">Voice Input</h2>
                                    
                                    <VoiceInput
                                        onTextReceived={handleVoiceText}
                                        onError={handleVoiceError}
                                        className="flex flex-col items-center"
                                    />
                                    
                                    {voiceError && (
                                        <div className="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                                            <div className="flex items-center space-x-2">
                                                <svg className="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                                </svg>
                                                <p className="text-sm text-red-300">{voiceError}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Test Controls */}
                                <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                    <h2 className="text-xl font-semibold text-white mb-4">Test Controls</h2>
                                    
                                    <button
                                        onClick={runAutomatedTests}
                                        className="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-4 py-3 rounded-lg transition-all duration-200 mb-4"
                                    >
                                        Run Automated Tests
                                    </button>

                                    <div className="space-y-2 text-sm">
                                        <h3 className="font-semibold text-gray-300">Manual Test Steps:</h3>
                                        <ol className="text-gray-400 space-y-1 list-decimal list-inside">
                                            <li>Click the voice button to start recording</li>
                                            <li>Speak some dialogue (e.g., "Hello, this is a test")</li>
                                            <li>Verify text appears in the script editor</li>
                                            <li>Check that text is inserted at cursor position</li>
                                            <li>Test auto-pause after 3 seconds of silence</li>
                                        </ol>
                                    </div>
                                </div>

                                {/* Test Results */}
                                {testResults.length > 0 && (
                                    <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                        <h2 className="text-xl font-semibold text-white mb-4">Test Results</h2>
                                        
                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                            {testResults.map((result, index) => (
                                                <div key={index} className={`p-3 rounded-lg ${
                                                    result.type === 'success' ? 'bg-green-900/20 border border-green-500/30' :
                                                    result.type === 'error' ? 'bg-red-900/20 border border-red-500/30' :
                                                    'bg-yellow-900/20 border border-yellow-500/30'
                                                }`}>
                                                    <div className="flex justify-between items-start">
                                                        <p className={`text-sm ${
                                                            result.type === 'success' ? 'text-green-300' :
                                                            result.type === 'error' ? 'text-red-300' :
                                                            'text-yellow-300'
                                                        }`}>
                                                            {result.message}
                                                        </p>
                                                        <span className="text-xs text-gray-500">{result.timestamp}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <button
                                            onClick={() => setTestResults([])}
                                            className="mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded-lg transition-colors"
                                        >
                                            Clear Results
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Requirements Verification */}
                        <div className="mt-8 bg-gradient-to-r from-purple-900/20 to-pink-900/20 backdrop-blur-sm border border-purple-500/20 rounded-2xl p-6">
                            <h2 className="text-xl font-semibold text-white mb-4">Task 8 Requirements Verification</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-3">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span className="text-sm text-gray-300">âœ“ Large circular voice button added to script editor</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span className="text-sm text-gray-300">âœ“ Web Speech API integrated with error handling</span>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span className="text-sm text-gray-300">âœ“ Speech converted to text and inserted at cursor</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                        <span className="text-sm text-gray-300">âœ“ Requirements 3.1, 3.5, 3.6 satisfied</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<Task8TestApp />, document.getElementById('root'));
    </script>
</body>
</html>