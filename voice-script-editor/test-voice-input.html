<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Input Test - ScriptEase</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: white;
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Mock User and Script data
        const mockUser = {
            id: '1',
            name: 'Test User',
            email: 'test@example.com'
        };

        const mockScript = {
            id: '1',
            title: 'Voice Input Test Script',
            description: 'Testing voice input functionality',
            content: 'FADE IN:\n\nINT. COFFEE SHOP - DAY\n\nA cozy coffee shop buzzes with morning activity.',
            pageCount: 1,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // Voice Input Component
        function VoiceInput({ onTextReceived, onError, className = '' }) {
            const [isListening, setIsListening] = useState(false);
            const [isSupported, setIsSupported] = useState(false);
            const [interimText, setInterimText] = useState('');
            const recognitionRef = useRef(null);
            const silenceTimeoutRef = useRef(null);

            useEffect(() => {
                // Check if speech recognition is supported
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                setIsSupported(!!SpeechRecognition);

                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';

                    recognition.addEventListener('start', () => {
                        setIsListening(true);
                        setInterimText('');
                    });

                    recognition.addEventListener('end', () => {
                        setIsListening(false);
                        setInterimText('');
                        if (silenceTimeoutRef.current) {
                            clearTimeout(silenceTimeoutRef.current);
                        }
                    });

                    recognition.addEventListener('result', (event) => {
                        let interimTranscript = '';
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        setInterimText(interimTranscript);

                        if (finalTranscript) {
                            onTextReceived(finalTranscript);
                            setInterimText('');
                            
                            // Reset silence timeout after receiving final text
                            if (silenceTimeoutRef.current) {
                                clearTimeout(silenceTimeoutRef.current);
                            }
                            
                            // Auto-pause after 3 seconds of silence
                            silenceTimeoutRef.current = setTimeout(() => {
                                if (recognitionRef.current && isListening) {
                                    recognition.stop();
                                }
                            }, 3000);
                        }
                    });

                    recognition.addEventListener('error', (event) => {
                        console.error('Speech recognition error:', event.error);
                        setIsListening(false);
                        setInterimText('');
                        
                        let errorMessage = 'Voice input error occurred';
                        switch (event.error) {
                            case 'no-speech':
                                errorMessage = 'No speech detected. Please try again.';
                                break;
                            case 'audio-capture':
                                errorMessage = 'Microphone not accessible. Please check permissions.';
                                break;
                            case 'not-allowed':
                                errorMessage = 'Microphone access denied. Please allow microphone access.';
                                break;
                            case 'network':
                                errorMessage = 'Network error. Please check your connection.';
                                break;
                            case 'service-not-allowed':
                                errorMessage = 'Speech recognition service not available.';
                                break;
                            default:
                                errorMessage = `Speech recognition error: ${event.error}`;
                        }
                        
                        onError?.(errorMessage);
                    });

                    recognition.addEventListener('speechstart', () => {
                        // Clear silence timeout when speech starts
                        if (silenceTimeoutRef.current) {
                            clearTimeout(silenceTimeoutRef.current);
                        }
                    });

                    recognition.addEventListener('speechend', () => {
                        // Start silence timeout when speech ends
                        silenceTimeoutRef.current = setTimeout(() => {
                            if (recognitionRef.current && isListening) {
                                recognition.stop();
                            }
                        }, 3000);
                    });

                    recognitionRef.current = recognition;
                }

                return () => {
                    if (recognitionRef.current) {
                        recognitionRef.current.stop();
                    }
                    if (silenceTimeoutRef.current) {
                        clearTimeout(silenceTimeoutRef.current);
                    }
                };
            }, [onTextReceived, onError, isListening]);

            const toggleListening = () => {
                if (!isSupported) {
                    onError?.('Speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }

                if (!recognitionRef.current) {
                    onError?.('Speech recognition not initialized.');
                    return;
                }

                if (isListening) {
                    recognitionRef.current.stop();
                    if (silenceTimeoutRef.current) {
                        clearTimeout(silenceTimeoutRef.current);
                    }
                } else {
                    try {
                        recognitionRef.current.start();
                    } catch (error) {
                        console.error('Failed to start speech recognition:', error);
                        onError?.('Failed to start voice input. Please try again.');
                    }
                }
            };

            if (!isSupported) {
                return (
                    <div className={`${className} flex flex-col items-center`}>
                        <button
                            disabled
                            className="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center cursor-not-allowed opacity-50"
                            title="Speech recognition not supported in this browser"
                        >
                            <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728" />
                            </svg>
                        </button>
                        <p className="text-xs text-gray-500 mt-2 text-center">
                            Voice input not supported
                        </p>
                    </div>
                );
            }

            return (
                <div className={`${className} flex flex-col items-center`}>
                    {/* Voice Input Button */}
                    <button
                        onClick={toggleListening}
                        className={`
                            w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-500/30
                            ${isListening 
                                ? 'bg-gradient-to-r from-red-500 to-red-600 shadow-lg shadow-red-500/30 animate-pulse' 
                                : 'bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 shadow-lg shadow-amber-500/30'
                            }
                        `}
                        title={isListening ? 'Stop voice input' : 'Start voice input'}
                    >
                        {isListening ? (
                            <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 6h12v12H6z"/>
                            </svg>
                        ) : (
                            <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        )}
                    </button>

                    {/* Status Text */}
                    <div className="mt-3 text-center min-h-[2.5rem]">
                        {isListening && (
                            <div className="space-y-1">
                                <p className="text-sm text-amber-300 font-medium">
                                    🎤 Listening...
                                </p>
                                {interimText && (
                                    <p className="text-xs text-gray-400 italic max-w-xs">
                                        "{interimText}"
                                    </p>
                                )}
                                <p className="text-xs text-gray-500">
                                    Speak now • Auto-pauses after 3 seconds of silence
                                </p>
                            </div>
                        )}
                        
                        {!isListening && (
                            <div className="space-y-1">
                                <p className="text-sm text-gray-300">
                                    Click to start voice input
                                </p>
                                <p className="text-xs text-gray-500">
                                    Speak dialogue, action lines, or scene descriptions
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Test App Component
        function VoiceInputTestApp() {
            const [content, setContent] = useState(mockScript.content);
            const [voiceError, setVoiceError] = useState(null);
            const [cursorPosition, setCursorPosition] = useState(0);
            const [receivedTexts, setReceivedTexts] = useState([]);
            const textareaRef = useRef(null);

            const handleVoiceText = (voiceText) => {
                const textarea = textareaRef.current;
                if (!textarea) return;

                // Get current cursor position
                const currentCursorPosition = textarea.selectionStart;
                
                // Insert voice text at cursor position
                const textBefore = content.substring(0, currentCursorPosition);
                const textAfter = content.substring(currentCursorPosition);
                
                // Clean up the voice text (capitalize first letter, add proper spacing)
                const cleanedVoiceText = voiceText.trim();
                const formattedText = cleanedVoiceText.charAt(0).toUpperCase() + cleanedVoiceText.slice(1);
                
                // Add appropriate spacing
                const needsSpaceBefore = textBefore.length > 0 && !textBefore.endsWith(' ') && !textBefore.endsWith('\n');
                const needsSpaceAfter = textAfter.length > 0 && !textAfter.startsWith(' ') && !textAfter.startsWith('\n');
                
                const finalText = (needsSpaceBefore ? ' ' : '') + formattedText + (needsSpaceAfter ? ' ' : '');
                const newContent = textBefore + finalText + textAfter;
                
                // Update content
                setContent(newContent);
                
                // Position cursor after inserted text
                const newCursorPosition = currentCursorPosition + finalText.length;
                setTimeout(() => {
                    textarea.selectionStart = textarea.selectionEnd = newCursorPosition;
                    textarea.focus();
                    setCursorPosition(newCursorPosition);
                }, 0);

                // Add to received texts log
                setReceivedTexts(prev => [...prev, {
                    text: voiceText,
                    formatted: finalText,
                    timestamp: new Date().toLocaleTimeString()
                }]);

                // Clear any voice errors
                setVoiceError(null);
            };

            const handleVoiceError = (error) => {
                setVoiceError(error);
                // Clear error after 5 seconds
                setTimeout(() => setVoiceError(null), 5000);
            };

            const handleContentChange = (e) => {
                setContent(e.target.value);
                setCursorPosition(e.target.selectionStart);
            };

            const handleSelectionChange = () => {
                if (textareaRef.current) {
                    setCursorPosition(textareaRef.current.selectionStart);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-amber-400 mb-2">Voice Input Test</h1>
                            <p className="text-gray-400">Test the voice input functionality for ScriptEase</p>
                        </div>

                        {/* Script Editor */}
                        <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6 mb-8">
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-300 mb-2">
                                    Script Content (Cursor Position: {cursorPosition})
                                </label>
                            </div>
                            
                            <textarea
                                ref={textareaRef}
                                value={content}
                                onChange={handleContentChange}
                                onSelect={handleSelectionChange}
                                onClick={handleSelectionChange}
                                placeholder="Start writing your script here..."
                                className="w-full h-64 bg-slate-700/50 border border-slate-600 rounded-lg p-4 text-white font-mono text-sm leading-relaxed resize-none focus:outline-none focus:ring-2 focus:ring-amber-500/50"
                            />
                        </div>

                        {/* Voice Input Section */}
                        <div className="flex justify-center mb-8">
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                <VoiceInput
                                    onTextReceived={handleVoiceText}
                                    onError={handleVoiceError}
                                    className="flex flex-col items-center"
                                />
                                
                                {/* Voice Error Display */}
                                {voiceError && (
                                    <div className="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                                        <div className="flex items-center space-x-2">
                                            <svg className="w-5 h-5 text-red-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                            </svg>
                                            <p className="text-sm text-red-300">{voiceError}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Voice Input Log */}
                        {receivedTexts.length > 0 && (
                            <div className="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6">
                                <h3 className="text-lg font-semibold text-amber-400 mb-4">Voice Input Log</h3>
                                <div className="space-y-3 max-h-64 overflow-y-auto">
                                    {receivedTexts.map((item, index) => (
                                        <div key={index} className="bg-slate-700/30 rounded-lg p-3">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-xs text-gray-400">{item.timestamp}</span>
                                            </div>
                                            <div className="space-y-1">
                                                <div>
                                                    <span className="text-xs text-gray-500">Original:</span>
                                                    <span className="text-sm text-gray-300 ml-2">"{item.text}"</span>
                                                </div>
                                                <div>
                                                    <span className="text-xs text-gray-500">Formatted:</span>
                                                    <span className="text-sm text-amber-300 ml-2">"{item.formatted}"</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button
                                    onClick={() => setReceivedTexts([])}
                                    className="mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm rounded-lg transition-colors"
                                >
                                    Clear Log
                                </button>
                            </div>
                        )}

                        {/* Instructions */}
                        <div className="mt-8 bg-gradient-to-r from-blue-900/20 to-cyan-900/20 backdrop-blur-sm border border-blue-500/20 rounded-2xl p-6">
                            <h3 className="text-lg font-semibold text-white mb-2">Test Instructions</h3>
                            <ul className="text-gray-300 space-y-1 text-sm">
                                <li>• Click the voice button to start/stop voice input</li>
                                <li>• Position your cursor in the text area where you want to insert text</li>
                                <li>• Speak clearly - the system will automatically pause after 3 seconds of silence</li>
                                <li>• Voice text will be inserted at the cursor position with proper formatting</li>
                                <li>• Try speaking dialogue, action lines, or scene descriptions</li>
                                <li>• Check the voice input log to see original vs formatted text</li>
                                <li>• Test error handling by denying microphone access or speaking in a noisy environment</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<VoiceInputTestApp />, document.getElementById('root'));
    </script>
</body>
</html>